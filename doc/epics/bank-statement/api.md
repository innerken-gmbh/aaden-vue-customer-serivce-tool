# Finance Reconciliation Module API

Scope: io.aaden.cloud.domain.cloud.finance.reconciliation.*

Notes

- CORS: All controllers use @CrossOrigin.
- Methods: Only GET and POST are used.
- Dates: ISO-8601 (e.g., 2025-01-31).
- File uploads: multipart/form-data. Single file part name: file; batch: files.
- DTOs only; no Map responses.

Business Logic (Short)

- Company: Create companies and maintain multiple department heads per company.
- Account: Each company can have multiple reconciliation bank accounts.
- Statement: Upload a bank statement PDF for an account. If the uploaded statement’s date range overlaps existing ones,
  the old statements (and their transactions) in the overlap are replaced. The PDF is stored and parsed by AI to create
  structured transactions.
- Transaction: Each parsed transaction belongs to a statement and includes metadata (name, description, note, date,
  amount,
  transactionType INCOME/OUTCOME, expenseType for OUTCOME, optional department head). Users can attach supporting
  files to transactions (single or batch). Initial submissionStatus is derived during AI parsing: if
  needToSubmitFile=false then NOT_REQUIRED; otherwise WAITING.

Controllers and Endpoints

1) CompanyController

- Base path: /recon/company

Endpoints

- POST /recon/company/save
  Request Body: CompanySaveDTO
    - id: Long? (optional; provide to update)
    - name: String (required)
    - departmentHeads: List<DepartmentHeadSaveDTO> (optional)
        - id: Long? (optional)
        - name: String (required)
        - notes: String? (optional)
    - notes: String? (optional)
      Response: CompanyDTO
    - id: Long
    - name: String
    - departmentHeads: List<DepartmentHeadDTO>
        - id: Long
        - name: String
        - notes: String?
        - companyId: Long
        - createTimestamp: LocalDateTime?
    - notes: String?
    - createTimestamp: LocalDateTime?

- GET /recon/company/list
  Query: none
  Response: List<CompanyDTO>

2) ReconciliationAccountController

- Base path: /recon/account

Endpoints

- POST /recon/account/save
  Request Body: ReconciliationAccountSaveDTO
    - id: Long? (optional)
    - companyId: Long (required)
    - bankName: String (required)
    - accountNumber: String (required)
    - alias: String? (optional)
      Response: ReconciliationAccountDTO
    - id: Long
    - companyId: Long
    - bankName: String
    - accountNumber: String
    - alias: String?
    - createTimestamp: LocalDateTime?

- GET /recon/account/list
  Query:
    - companyId: Long (required)
      Response: List<ReconciliationAccountDTO>
      Notes:
    - Soft-delete: the list excludes accounts where deletedAt is set (only active accounts are returned).

- POST /recon/account/delete
  Request Body: ReconciliationAccountDeleteDTO
    - id: Long (required)
      Response: ReconciliationAccountDeleteResultDTO
    - success: Boolean
    - deletedAt: LocalDateTime?

3) BankStatementController

- Base path: /recon/statement

Endpoints

- GET /recon/statement/list
  Query:
    - accountId: Long (required)
      Response: List<BankStatementDTO>
    - id: Long
    - accountId: Long
    - name: String
    - description: String?
    - startDate: LocalDate
    - endDate: LocalDate
    - fileUrl: String
    - parsed: Boolean
    - createTimestamp: LocalDateTime?

- POST /recon/statement/upload
  Content-Type: multipart/form-data
  Params (form fields):
    - accountId: Long (required)
    - description: String? (optional)
      Parts:
    - file: MultipartFile (required)
      Response: BankStatementDTO
      Behavior:
    - Stores the PDF to S3 and triggers AI parsing to extract transactions.
    - The statement's name is generated by AI based on account info and the derived date range; client should not pass a
      name.
    - The statement's startDate/endDate are derived from parsed transactions (min/max date).
    - For de-duplication: the MD5 of the uploaded statement file is stored; if a statement with the same MD5 already
      exists for the account, the existing statement is returned without re-processing.
    - Existing statements that overlap the derived date range for the same account are replaced along with their
      transactions.

- GET /recon/statement/export
  Query:
    - statementId: Long (required)
      Response: application/zip (attachment)
      Behavior:
    - Returns a ZIP named "statement#<id>.zip" with structure:
        - transactions.xlsx: All transactions with columns (id, date, name, amount, type, expenseType, tag,
          attachmentFileName).
        - income/ -> DD_MM_YYYY_name_amount.pdf per INCOME transaction.
        - outcome/management/ -> DD_MM_YYYY_name_amount.pdf for OUTCOME with MANAGEMENT (default bucket when
          unspecified).
        - outcome/production/ -> DD_MM_YYYY_name_amount.pdf for OUTCOME with PRODUCTION.
    - Only transactions with an attached file (fileUrl) are included as PDF entries; transactions without attachments
      are omitted.

4) BankTransactionController

- Base path: /recon/transaction

Endpoints

- GET /recon/transaction/list
  Query:
    - statementId: Long (required)
      Response: List<BankTransactionDTO>
    - id: Long
    - statementId: Long
    - account: TransactionAccountDTO?
        - id: Long
        - bankName: String
        - accountNumber: String
        - alias: String?
        - name: String
        - description: String?
        - note: String?
            - date: LocalDate
            - amount: BigDecimal (income positive, expense negative)
            - transactionType: TransactionType (INCOME | OUTCOME)
            - tag: String?
            - categoryNote: String?
            - submissionStatus: SubmissionStatus (WAITING | NOT_REQUIRED | INVALID_CONTENT | SUBMITTED)
                - fileUrl: String?
                - fileName: String?
                - expenseType: ExpenseType? (PRODUCTION | MANAGEMENT)
                - departmentHead: TransactionDepartmentHeadDTO?
                    - id: Long
                    - name: String
                - createTimestamp: LocalDateTime?

- GET /recon/transaction/list-by-company
  Query:
    - companyId: Long (required)
      Response: List<BankTransactionDTO> (same schema as above)

- GET /recon/transaction/list-by-account
  Query:
    - accountId: Long (required)
      Response: List<BankTransactionDTO> (same schema as above)

- POST /recon/transaction/save
  Request Body: BankTransactionSaveDTO
    - id: Long? (optional; include to update)
    - statementId: Long (required)
    - name: String (required)
    - description: String? (optional)
    - note: String? (optional; max length 1000; remarks/备注)
        - date: LocalDate (required)
        - amount: BigDecimal (required)
        - transactionType: TransactionType (INCOME | OUTCOME)
        - tag: String? (optional)
        - categoryNote: String? (optional)
        - expenseType: ExpenseType? (PRODUCTION | MANAGEMENT)
        - departmentHeadId: Long? (optional)
        - submissionStatus: SubmissionStatus? (optional; default: WAITING unless fileUrl present then SUBMITTED)
        - fileUrl: String? (optional)
        - fileName: String? (optional)
          Response: BankTransactionDTO (same schema as above)

- POST /recon/transaction/upload-attachment
  Params (form fields):
    - transactionId: Long (required)
      Parts:
    - file: MultipartFile (required)
      Response: BankTransactionDTO (updated with fileUrl/fileName; submissionStatus=SUBMITTED)


- POST /recon/transaction/batch-upload-attachments
  Params (form fields):
    - statementId: Long (required)
      Parts:
    - files: List<MultipartFile> (required)
      Response: TransactionAttachmentAIPreviewResponseDTO
    - items: List<TransactionAttachmentAIPreviewItemDTO>
        - fileUrl: String
        - title: String?
        - amount: BigDecimal?
        - account: String?
        - date: LocalDate?
        - validBill: Boolean
        - matchedTransactionId: Long?
        - matchedStatementId: Long?
        - categoryNote: String?
          Behavior:
    - Non-destructive preview: does not modify transactions.
    - Only considers transactions with submissionStatus in [WAITING, INVALID_CONTENT] for matching during preview.
    - AI sees all uploaded files and eligible statement transactions to propose matches.
    - MD5 cache: reuses previous AI results for identical file content.
    - Internal keying: AI analysis and caching are keyed by fileMd5 (content hash); fileUrl may change but cache still
      applies.

- POST /recon/transaction/apply-attachments
  Request Body: ApplyAttachmentsRequestDTO
    - items: List<ApplyAttachmentItemDTO>
        - transactionId: Long
        - fileUrl: String
        - fileName: String?
        - categoryNote: String? (optional)
          Response: ApplyAttachmentsResponseDTO
    - items: List<BankTransactionDTO> (same schema as in GET /recon/transaction/list)
      Behavior:
    - Applies the confirmed mapping of files to transactions (persists fileUrl/fileName/categoryNote and sets submitted
      accordingly).

## Change Log

- 2025-11-02 09:32
    - Added note field (nullable, max length 1000) to BankTransaction entity and surfaced via BankTransactionDTO and
      BankTransactionSaveDTO. Documentation updated accordingly in request/response schemas.
    - Compatibility: additive field; existing clients unaffected.

- 2025-10-26 16:22
    - Documentation aligned with current implementation:
        - Removed undocumented endpoint POST /recon/transaction/save-attachment (not present in controller).
        - Documented categoryNote in POST /recon/transaction/apply-attachments request items and noted it is persisted.
        - Clarified that batch preview only matches transactions with submissionStatus in [WAITING, INVALID_CONTENT].
    - Note: Added Lark success notification after parseStatementWithAI completes (no API change).

- 2025-10-26 15:40
    - Added categoryNote field throughout reconciliation:
        - BankTransaction entity and persistence layer
        - BankTransactionDTO and BankTransactionSaveDTO
        - TransactionAttachmentAIPreviewItemDTO
        - AttachmentAnalysis cache
    - Batch upload preview (POST /recon/transaction/batch-upload-attachments) now only considers transactions with
      submissionStatus in [WAITING, INVALID_CONTENT].
    - AI preview behavior updated to include categoryNote with special rule: if matched transaction is INCOME and
      category is 营业收入, append invoice number as 营业收入Rn.<编号> when identifiable.

